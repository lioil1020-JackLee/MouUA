name: ModUA

on:
  push:
    branches: [ "main" ]
    tags: [ "v*" ] # 當推送 v1.0, v2.1 等標籤時觸發 Release
  workflow_dispatch:

permissions:
  contents: write # 賦予腳本權限建立 Release

jobs:
  build:
    name: Build ${{ matrix.build_type }} on ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-latest, macos-latest]
        build_type: [onedir, onefile]
    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Set up Python
        run: uv python install 3.12

      - name: Install dependencies
        shell: bash
        run: |
          uv venv
          source .venv/bin/activate 2>/dev/null || . .venv/Scripts/activate
          uv pip install pyinstaller
          if [ -f requirements.txt ]; then uv pip install -r requirements.txt; fi

      - name: Build onedir (Windows)
        if: matrix.build_type == 'onedir' && matrix.os == 'windows-latest'
        shell: bash
        run: |
          # 檢查圖示是否存在
          ICON_PARAM=""
          if [ -f "lioil.ico" ]; then ICON_PARAM="--icon=lioil.ico"; fi

          # Windows 路徑分隔符
          uv run pyinstaller --onedir --windowed $ICON_PARAM \
            --add-data "ui;ui" \
            --add-data "images;images" \
            --add-data "core;core" \
            --add-data "certs;certs" \
            --name "ModUA-onedir" \
            ModUA.py

      - name: Build onefile (Windows)
        if: matrix.build_type == 'onefile' && matrix.os == 'windows-latest'
        shell: bash
        run: |
          # 檢查圖示是否存在
          ICON_PARAM=""
          if [ -f "lioil.ico" ]; then ICON_PARAM="--icon=lioil.ico"; fi

          # Windows 路徑分隔符
          uv run pyinstaller --onefile --windowed $ICON_PARAM \
            --add-data "ui;ui" \
            --add-data "images;images" \
            --add-data "core;core" \
            --add-data "certs;certs" \
            --name "ModUA-onefile" \
            ModUA.py

      - name: Build macOS App (onedir)
        if: matrix.os == 'macos-latest' && matrix.build_type == 'onedir'
        shell: bash
        run: |
          # 檢查圖示是否存在
          ICON_PARAM=""
          if [ -f "lioil.icns" ]; then ICON_PARAM="--icon=lioil.icns"; fi

          # macOS 建立 .app (類似 onedir)
          uv run pyinstaller --onedir --windowed $ICON_PARAM \
            --add-data "ui:ui" \
            --add-data "images:images" \
            --add-data "core:core" \
            --add-data "certs:certs" \
            --name "ModUA-macos" \
            ModUA.py

      - name: Build macOS onefile
        if: matrix.os == 'macos-latest' && matrix.build_type == 'onefile'
        shell: bash
        run: |
          # 檢查圖示是否存在
          ICON_PARAM=""
          if [ -f "lioil.icns" ]; then ICON_PARAM="--icon=lioil.icns"; fi

          # macOS onefile 版本
          uv run pyinstaller --onefile --windowed $ICON_PARAM \
            --add-data "ui:ui" \
            --add-data "images:images" \
            --add-data "core:core" \
            --add-data "certs:certs" \
            --name "ModUA-macos-onefile" \
            ModUA.py

      # 因為 macOS 的 .app 是資料夾，必須壓縮後才能 Release
      - name: Zip macOS App
        if: matrix.os == 'macos-latest' && matrix.build_type == 'onedir'
        shell: bash
        run: |
          cd dist
          zip -r ModUA-macOS-onedir.zip ModUA-macos.app

      - name: Zip macOS onefile
        if: matrix.os == 'macos-latest' && matrix.build_type == 'onefile'
        shell: bash
        run: |
          cd dist
          zip -r ModUA-macOS-onefile.zip ModUA-macos-onefile

      - name: Upload Artifact (Actions 臨時存檔)
        uses: actions/upload-artifact@v4
        with:
          name: ModUA-${{ matrix.build_type }}-${{ matrix.os }}
          path: dist/ModUA*

  # 新增 Release Job：收集所有產物並上傳到 Release
  release:
    name: Create Release
    needs: build
    # 支援 Tag 觸發或手動觸發
    if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    permissions:
      contents: write 
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: raw_artifacts

      - name: Prepare Release Assets
        shell: bash
        run: |
          mkdir -p final_assets
          # 1. 處理已經是單一檔案的東西 (例如 .zip 或 onefile 的 .exe)
          find raw_artifacts -type f \( -name "*.zip" -o -name "*.exe" \) -exec cp {} final_assets/ \;
          
          # 2. 處理 Windows onedir 資料夾 (它目前是資料夾，直接上傳會失敗)
          # 檢查是否有 onedir 資料夾存在，有的話就壓縮它
          for dir in raw_artifacts/*-onedir-windows-latest/; do
            if [ -d "$dir" ]; then
              dirname=$(basename "$dir")
              echo "Archiving Windows onedir: $dirname"
              zip -r "final_assets/Alldesk-Windows-onedir.zip" "$dir"
            fi
          done

          echo "準備上傳的檔案清單："
          ls -lh final_assets/

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          # 這裡確保只上傳壓縮後的檔案，避免觸發次要速率限制
          files: final_assets/*
          tag_name: ${{ github.ref_name }}
          generate_release_notes: true
          body: |
            ## Alldesk ${{ github.ref_name }} Release
            
            自動編譯版本包含：
            - Windows (onedir & onefile)
            - macOS (onedir & onefile)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}